@page "/profile"
@using IntegrationV3R_PortailFournisseur.Shared.ComposantsProfile
@using Microsoft.EntityFrameworkCore
@using IntegrationV3R_PortailFournisseur.Data.Models

@inject ApplicationDbContext dbContext
@inject NavigationManager Navigation
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<PageTitle>Profile</PageTitle>

<div class="container-fluid mt-4">

    <!-- Button to Toggle Identification Section -->
    <button class="btn btn-primary mb-3" @onclick="ToggleIdentificationVisibility">
        @if (isIdentificationVisible)
        {
            <text>Hide Identification</text>
        }
        else
        {
            <text>Show Identification</text>
        }
    </button>

    <!-- Conditionally show the Identification component -->
    @if (isIdentificationVisible)
    {
        <CompProfileIdentification neq="@neq"
                               nomEntreprise="@nomEntreprise"
                               courrielEntreprise="@courrielEntreprise" />
    }

    <!-- Button to Toggle Address Section -->
    <button class="btn btn-primary mb-3" @onclick="ToggleAddressVisibility">
        @if (isAddressVisible)
        {
            <text>Hide Address</text>
        }
        else
        {
            <text>Show Address</text>
        }
    </button>

    <!-- Conditionally show the Address Section -->
    @if (isAddressVisible)
    {
        <CompProfileAdresse NumeroCiv="@numeroCiv"
                            Rue="@rue"
                            Ville="@ville"
                            Province="@province"
                            CodePostal="@codePostal"
                            RegionAdministrative="@regionAdministrative"
                            NumeroTelephone="@numeroTelephone" />
    }

    <!-- Button to Toggle Contacts Section -->
    <button class="btn btn-primary mb-3" @onclick="ToggleContactsVisibility">
        @if (isContactsVisible)
        {
            <text>Hide Contacts</text>
        }
        else
        {
            <text>Show Contacts</text>
        }
    </button>

    <!-- Conditionally show the Contacts Section -->
    @if (isContactsVisible)
    {
        <CompProfileContact Contacts="@contacts" />
    }

    <div class="profile-container">

        <!-- Products/Services Section -->
        <h5>Products/Services</h5>
        @if (products != null && products.Any())
        {
            @foreach (var product in products)
            {
                <div class="product-entry mb-3 row">
                    <div class="col-6 mb-3">
                        <strong>Comodite: </strong> @product.ComoditeId<br>
                        <!--<strong>Details:</strong> @product.Details<br>-->
                    </div>
                </div>
            }
        }
        else
        {
            <div>No products/services available.</div>
        }

        <!-- RBQ Section -->
        <h5>RBQ Details</h5>
        @if (rbqDetails != null && rbqDetails.Any())
        {
            @foreach (var rbq in rbqDetails)
            {
                <div class="rbq-entry mb-3 row">
                    <div class="col-6 mb-3">
                        <strong>Numéro RBQ:</strong> @rbq.NumLicence<br>
                        <strong>Nom Sous-catégorie:</strong> @rbq.SouscategorieLicencerbq<br>
                    </div>
                </div>
            }
        }
        else
        {
            <div>No RBQ details available.</div>
        }

        <!-- Finances Section -->
        <h5>Finances</h5>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>TPS Number:</strong> @tps
            </div>

            <div class="col-md-6">
                <strong>TVQ Number:</strong> @tvq
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <strong>Payment Terms:</strong> @conditionPaiement
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <strong>Currency</strong> @devise
            </div>

            <div class="col-md-6">
                <strong>Communication Mode</strong> @modeCom
            </div>
        </div>
    </div>
</div>

@code {

    private bool isUserAuthenticated = false;
    private Fournisseur fournisseur;

    [Parameter] public EventCallback<bool> BDFetched { get; set; }

    private string neq = "";
    private string nomEntreprise = "";
    private string courrielEntreprise = "";

    private bool isIdentificationVisible = false; // Flag to toggle identification visibility
    private bool isAddressVisible = false; // Flag to toggle address visibility
    private bool isContactsVisible = false; // Flag to toggle contacts visibility

    private void ToggleIdentificationVisibility()
    {
        isIdentificationVisible = !isIdentificationVisible; // Toggle visibility flag
    }

    private void ToggleAddressVisibility()
    {
        isAddressVisible = !isAddressVisible; // Toggle visibility flag for the address
    }

    private void ToggleContactsVisibility()
    {
        isContactsVisible = !isContactsVisible; // Toggle visibility flag for contacts
    }

    private string numeroCiv = "";
    private string rue = "";
    private string ville = "";
    private string province = "";
    private string codePostal = "";
    private string regionAdministrative = "";
    private string numeroTelephone = "";

    public string tvq = "";
    public string tps = "";
    public string conditionPaiement = "";
    public string devise = "";
    public string modeCom = "";

    private List<Contact> contacts = new List<Contact>();
    private List<Produitsservice> products = new List<Produitsservice>();
    private List<Licencesrbq> rbqDetails = new List<Licencesrbq>(); // RBQ list for display

    protected override async Task OnInitializedAsync()
    {
        await FetchDataDB();

        var userId = await sessionStorage.GetItemAsync<int?>("UserId");

        if (userId == null)
        {
            Navigation.NavigateTo("/connexion");
        }
        else
        {
            isUserAuthenticated = true;
            var user = await dbContext.Users
                .Include(u => u.Fournisseur)
                    .ThenInclude(f => f.Adresses)
                .Include(u => u.Fournisseur)
                    .ThenInclude(f => f.Contacts)
                .Include(u => u.Fournisseur)
                    .ThenInclude(f => f.Finances)
                .Include(u => u.Fournisseur)
                    .ThenInclude(f => f.Produitsservices)
                //.Include(u => u.Fournisseur)
                //    .ThenInclude(f => f.)
                .Include(u => u.Fournisseur) // Include RBQ entities
                    .ThenInclude(f => f.Rbqs) // Assuming this is the navigation property
                .FirstOrDefaultAsync(u => u.UserId == userId);

            if (user != null)
            {
                fournisseur = user.Fournisseur;
                if (fournisseur != null)
                {
                    // Set identification fields
                    neq = fournisseur.Neq; // Assuming Fournisseur has a property for NEQ
                    nomEntreprise = fournisseur.NomEntreprise; // Assuming Fournisseur has a property for the company name
                    courrielEntreprise = fournisseur.CourrielEntreprise; // Assuming Fournisseur has a property for the email

                    // Set address fields
                    var address = fournisseur.Adresses.FirstOrDefault(); // Assuming there is at least one address
                    var region = fournisseur.region
                    if (address != null)
                    {
                        numeroCiv = address.NumeroCivique; // Ensure you have these properties in your address model
                        rue = address.Rue;
                        ville = address.CodeMunicipalite /*DOOIT CHANG> POUR TROUVER LE NOM A CE CODE DE MUNICIPALITE*/;
                        province = address.CodeProvince /*IDEM !!!!!!*/;
                        codePostal = address.CodePostal;
                        regionAdministrative = GetRegionName(address.CodeRegionAdministrative); /*DOIT PASSER PAR PROVINCE PUIS REGION*/
                        numeroTelephone = address.NumTel;
                    }

                    var finance = fournisseur.Finances.FirstOrDefault(); // Assuming there is at least one address
                    if (finance != null)
                    {
                        tvq = finance.Tvq;
                        tps = finance.Tps;
                        conditionPaiement = finance.CodeConditionPaiement;
                        devise = finance.Devise;
                        modeCom = finance.ModeCom;
                    }

                    // Fetch products/services
                    products = fournisseur.Produitsservices.ToList(); // Assuming this is correctly populated

                    // Fetch RBQ details
                    rbqDetails = fournisseur.Licencesrbqs.ToList(); // Adjust as per your model

                    // Fetch contacts
                    contacts = fournisseur.Contacts.ToList(); // Fetching contacts from fournisseur
                }
            }
        }
    }

    private List<Regionadministrative> regions = new List<Regionadministrative>();
    

    private string GetRegionName(string code)
    {
        var region = regions.FirstOrDefault(r => r.CodeRegionAdministrative == code);
        return region != null ? region.NomRegionAmdin : "Région non disponible";
    }

    public async Task FetchDataDB()
    {
        try
        {
            regions = await dbContext.Regionadministratives.ToListAsync();
        }
        catch (Exception ex)
        {
            regionAdministrative = "Erreur lors de la récupération des régions.";
            Console.WriteLine(ex.Message);
        }
        BDFetched.InvokeAsync(true);
    }
}
